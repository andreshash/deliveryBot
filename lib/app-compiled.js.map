{"version":3,"sources":["app.js"],"names":[],"mappings":"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","file":"app-compiled.js","sourcesContent":["import * as types from './constants/actionTypes'\nimport * as Actions from './actions/index'\nimport config from 'config'\nimport request from 'request'\nimport HashMap  from 'hashmap'\nimport FB from 'fb'\nimport https from 'https'\n\nimport * as _ from 'underscore'\n//import * as redux from 'redux'\n\nimport Parse from 'parse/node'\nimport {\n    app,\n    rules,\n    callSendAPI,\n    sendTypingOn,\n    sendTypingOff\n} from './bot'\n\n//GetProductsParams = require('./models/GetProductsParams')\n\nvar ParseModels = require('./ParseModels');\nvar Consumer = require('./ParseModels').Consumer;\nvar User = require('./ParseModels').User;\nvar ConsumerAddress = require('./ParseModels').ConsumerAddress;\n\nconst APP_SECRET = (process.env.MESSENGER_APP_SECRET) ? process.env.MESSENGER_APP_SECRET : config.get('APP_SECRET');\n\nconst PAGE_ACCESS_TOKEN = (process.env.MESSENGER_PAGE_ACCESS_TOKEN) ? (process.env.MESSENGER_PAGE_ACCESS_TOKEN) : config.get('PAGE_ACCESS_TOKEN');\n\nconst PARSE_APP_ID = (process.env.PARSE_APP_ID) ? (process.env.PARSE_APP_ID) : config.get('PARSE_APP_ID');\n\nconst PARSE_SERVER_URL = (process.env.PARSE_SERVER_URL) ? (process.env.PARSE_SERVER_URL) : config.get('PARSE_SERVER_URL');\n\nconst FACEBOOK_APP_ID = (process.env.FACEBOOK_APP_ID) ? (process.env.FACEBOOK_APP_ID) : config.get('FACEBOOK_APP_ID');\n\nconst REDIRECT_URI = (process.env.REDIRECT_URI) ? (process.env.REDIRECT_URI) : config.get('REDIRECT_URI');\n\nconst BUSINESS_ID = (process.env.BUSINESS_ID) ? (process.env.BUSINESS_ID) : config.get('BUSINESS_ID');\n\nconst limit = 9;\n\nParse.initialize(PARSE_APP_ID);\nParse.serverURL = PARSE_SERVER_URL;\n\nFB.options({\n    appId:          FACEBOOK_APP_ID,\n    appSecret:      APP_SECRET,\n    redirectUri:    REDIRECT_URI\n});\n\nconsole.log(FB)\n\nglobal.Parse = Parse;\nglobal.FB = FB;\n\n//console.log(FB.getLoginUrl({ scope: 'user_about_me' }));\n\n/*\n Parse.FacebookUtils.init({ // this line replaces FB.init({\n appId      : FACEBOOK_APP_ID, // Facebook App ID\n cookie     : true,  // enable cookies to allow Parse to access the session\n xfbml      : true,  // initialize Facebook social plugins on the page\n version    : 'v2.4' // point to the latest Facebook Graph API version\n });\n*/\n\nrules.set('hola', sendMenuMessage);\nrules.set('cuenta', sendBillMessage);\n\nvar order = new HashMap();\n\nfunction sendMenuMessage(recipientId) {\n    console.log('Typing ON');\n    sendTypingOn(recipientId);\n\n    new Parse.Query(User).get('DH6JIZFrGW').then(\n        function (user) {\n            var login = Actions.loadConsumer(user, {});\n            console.log('user');\n            console.log(user);\n            console.log('login');\n            console.log(login());\n\n            new Parse.Query(Consumer).equalTo('user', user).first().then(consumer => {\n                if (consumer) {\n                    request({\n                        uri: 'https://graph.facebook.com/v2.6/' + recipientId,\n                        qs: {access_token: PAGE_ACCESS_TOKEN, fields: 'first_name,last_name,locale,timezone,gender'},\n                        method: 'GET'\n                    }, renderMenuMessage);\n                }\n            }).fail(error => {\n                console.log(error);\n            })\n        },\n        function (object, error) {\n            console.log(error);\n            // error is an instance of Parse.Error.\n        });\n};\n\nfunction listCategories(recipientId, catIdx){\n    console.log('Typing ON');\n    sendTypingOn(recipientId);\n\n    Parse.Cloud.run('getProducts', { businessId: BUSINESS_ID }).then(function(result){\n            var elements = splitCategories(result.categories, catIdx);\n            var idx = Object.keys(result.categories).length;\n            var buttons = [];\n            var catIni = (catIdx+1)*limit;\n            var catFin =  (idx > catIni+limit) ? catIni+limit : idx;\n\n            console.log('length: '+idx);\n            console.log('limit: '+(catIdx+1)*limit);\n\n            if(idx > (catIdx+1)*limit){\n                buttons.push({\n                    type: \"postback\",\n                    title: \"Categorias \"+(catIni+1)+\"-\"+catFin,\n                    payload: \"ListCategories-\"+(catIdx+1),\n                });\n\n                elements.push({\n                    title: \"Más categorias \",\n                    subtitle: \"Categorias disponibles\",\n                    buttons: buttons\n                });\n            }\n\n            var messageData = {\n                recipient: {\n                    id: recipientId\n                },\n                message: {\n                    attachment: {\n                        type: \"template\",\n                        payload: {\n                            template_type: \"generic\",\n                            elements: elements\n                        }\n                    }\n                }\n            };\n\n            console.log('Typing OFF');\n            sendTypingOff(recipientId);\n            callSendAPI(messageData);\n\n        },\n        function(error) {\n\n        });\n}\n\nfunction listProducts(recipientId, category, proIdx){\n    sendTypingOn(recipientId);\n\n    Parse.Cloud.run('getProducts', { businessId: BUSINESS_ID, category: category }).then(function(result) {\n\n            var elements = splitProducts(result.products, proIdx);\n            var idx = Object.keys(result.products).length;\n            var buttons = [];\n\n            if( idx > (proIdx+1)*limit ){\n                buttons.push({\n                    type: \"postback\",\n                    title: \"Más productos \",\n                    payload: \"ListProducts-\"+category+\"-\"+(proIdx+1),\n                });\n\n                elements.push({\n                    title: \"Más categorias \",\n                    subtitle: \"Categorias disponibles\",\n                    buttons: buttons\n                });\n            }\n\n            var messageData = {\n                recipient: {\n                    id: recipientId\n                },\n                message: {\n                    attachment: {\n                        type: \"template\",\n                        payload: {\n                            template_type: \"generic\",\n                            elements: elements\n                        }\n                    }\n                }\n            };\n\n            sendTypingOff(recipientId);\n            callSendAPI(messageData);\n        },\n        function(error) {\n\n        })\n};\n\nfunction addProduct(id){\n    if(!order.get(id)){\n        order.set(id, 1);\n    }\n    else{\n        order.set(id, order.get(id)+1);\n    }\n    console.log(\"add product: \"+id);\n    console.log(\"order.count\");\n    console.log(order.count());\n}\n\nfunction sendBillMessage(recipientId){\n    // Generate a random receipt ID as the API requires a unique ID\n    sendTypingOn(recipientId);\n\n    var receiptId = \"order\" + Math.floor(Math.random()*1000);\n    var elements = [];\n    var element = {};\n    var total = 0;\n    var orderLimit = order.count();\n    var ind = 0;\n    var image;\n    var image_url;\n\n    order.forEach(function(value, key){\n        var Product = Parse.Object.extend(\"Product\");\n        var product = new Parse.Query(Product);\n        console.log(key);\n\n        product.get(key, {\n            success: function (item) {\n                image = item.get('image');\n                image_url = \"http://pro.parse.inoutdelivery.com/parse/files/hSMaiK7EXqDqRVYyY2fjIp4lBweiZnjpEmhH4LpJ/2671158f9c1cb43cac1423101b6e451b_image.txt\"\n                if(image){\n                    image_url = image.url();\n                }\n\n                element = {}\n                element['title'] = item.get('name');\n                element['subtitle'] = item.get('description');\n                element['quantity'] = order.get(key);\n                element['price'] = parseInt(item.get('priceDefault'));\n                element['currency'] = \"COP\";\n                element['image_url'] = image_url;\n\n                elements.push(element);\n                total += element['quantity']*element['price'];\n\n                ind++;\n\n                if(ind == orderLimit){\n\n                    request({\n                        uri: 'https://graph.facebook.com/v2.6/'+recipientId,\n                        qs: { access_token: PAGE_ACCESS_TOKEN, fields: 'first_name,last_name,locale,timezone,gender' },\n                        method: 'GET'\n\n                    }, function (error, response, body) {\n                        if (!error && response.statusCode == 200) {\n                            var userData = JSON.parse(body);\n                            console.log(userData)\n\n                            var messageData = {\n                                recipient: {\n                                    id: recipientId\n                                },\n                                message:{\n                                    attachment: {\n                                        type: \"template\",\n                                        payload: {\n                                            template_type: \"receipt\",\n                                            recipient_name: userData.first_name+\" \"+userData.last_name,\n                                            order_number: receiptId,\n                                            currency: \"COP\",\n                                            payment_method: \"Visa 1234\",\n                                            timestamp: Math.trunc(Date.now()/1000).toString(),\n                                            elements: elements,\n                                            address: {\n                                                street_1: \"Carrera x con calle x\",\n                                                street_2: \"\",\n                                                city: \"Bucaramanga\",\n                                                postal_code: \"680001\",\n                                                state: \"SA\",\n                                                country: \"CO\"\n                                            },\n                                            summary: {\n                                                subtotal: total,\n                                                shipping_cost: 2000.00,\n                                                total_tax: total*0.16,\n                                                total_cost: total*1.16+2000.00\n                                            }\n                                            //adjustments: [{\n                                            //  name: \"New Customer Discount\",\n                                            //  amount: -1000\n                                            //}, {\n                                            //    name: \"$1000 Off Coupon\",\n                                            //    amount: -1000\n                                            //}]\n                                        }\n                                    }\n                                }\n                            };\n                            order = new HashMap();\n                            console.log(\"callSendAPI(messageData)\");\n                            sendTypingOff(recipientId);\n                            callSendAPI(messageData);\n\n                        }\n                    });\n                }\n            },\n            error: function (error) {\n                alert(\"Error: \" + error.code + \" \" + error.message);\n            }\n        })\n    });\n}\n\nfunction splitCategories(categories, catIdx){\n    var idx = 0;\n    var elements = [];\n\n    categories.forEach(function(item){\n        //console.log(item.get('name'));\n        if(item && item.get('name')){\n            //console.log(elements.length);\n            if(idx >= (catIdx)*limit && idx < (catIdx+1)*limit){\n                var image = item.get('image');\n                var image_url = \"http://pro.parse.inoutdelivery.com/parse/files/hSMaiK7EXqDqRVYyY2fjIp4lBweiZnjpEmhH4LpJ/2671158f9c1cb43cac1423101b6e451b_image.txt\"\n                if(image){\n                    image_url = image.url();\n                }\n                elements.push({\n                    title: item.get('name'),\n                    //subtitle: item.get('name'),\n                    //item_url: \"http://www.mycolombianrecipes.com/fruit-cocktail-salpicon-de-frutas\",\n                    image_url: image_url,\n                    buttons: [{\n                        type: \"postback\",\n                        title: item.get('name'),\n                        payload: \"ListProducts-\"+item.id+\"-\"+catIdx,\n                    }]\n                })\n            }\n            idx = idx+1;\n        }\n    });\n    return elements;\n}\n\nfunction splitProducts(products, proIdx){\n    var idx = 0;\n    var elements = [];\n\n    products.forEach(function(item){\n        if(item && item.get('name')){\n            if(idx >= (proIdx)*limit && idx < (proIdx+1)*limit){\n                var image = item.get('image');\n                var image_url = \"http://pro.parse.inoutdelivery.com/parse/files/hSMaiK7EXqDqRVYyY2fjIp4lBweiZnjpEmhH4LpJ/2671158f9c1cb43cac1423101b6e451b_image.txt\"\n                if(image){\n                    image_url = image.url();\n                }\n                elements.push({\n                    title: item.get('name') +\": $\"+ item.get('priceDefault'),\n                    subtitle: item.get('description'),\n                    //item_url: \"http://www.mycolombianrecipes.com/fruit-cocktail-salpicon-de-frutas\",\n                    image_url: image_url,\n                    buttons: [{\n                        type: \"postback\",\n                        title: \"Agregar\",\n                        payload: \"Add-\"+item.id,\n                    }]\n                })\n            }\n            idx = idx+1;\n        }\n    });\n    return elements;\n}\n\nfunction renderMenuMessage(error, response, body) {\n    if (!error && response.statusCode == 200) {\n        var pathname = response.request.uri.pathname;\n        var recipientId = pathname.split('/').pop();\n        var userData = JSON.parse(body);\n        var commerce = new Parse.Query(ParseModels.Customer);\n\n        //user.equalTo('authData', {\"facebook\":        {\"access_token\":\"EAAPK2ME0gLkBAE6HMBKLP2RfquPvCIyaXNuItGYRdBpJNArGCZC9UzITl9ZBB7EKnmuukylXS93yhHOZAUiHjPwGyNBmnb11VPB7kf0Km9o2Gm2hFSJhDmjpZA1bfZCITRQ45OCMVAIWSR3jHIjkg3cze6tSvZBQjKdGkalGA1V7E0npkZAcMPn51z2yLAPJVRzRpbTqNCTtNPIhxpBr7H2\",\"expiration_date\":\"2016-10-02T15:16:42.000Z\",\"id\":\"10210218101474882\"}})\n\n        commerce.contains('businessId', BUSINESS_ID);\n\n        commerce.find().then(function(results){\n                var currentUser = Parse.User.current();\n                var image_url = results[0].get('image').url();\n\n                console.log('data');\n                console.log(recipientId);\n                console.log(results);\n                console.log(image_url);\n\n                var messageData = {\n                    recipient: {\n                        id: recipientId\n                    },\n                    message: {\n                        attachment: {\n                            type: \"template\",\n                            payload: {\n                                template_type: \"generic\",\n                                //text: \"Buenos dias, para conocer nuestros menus del dia, por favor escoja una opción:\",\n                                elements: [{\n                                    \"title\":     \"Hola \"+userData.first_name+\", Bienvenido a OXXO. \",\n                                    \"subtitle\":  \"Aquí puedes pedir un domicilio, escribe o selecciona alguna de las opciones:\",\n                                    \"image_url\": image_url,\n                                    \"buttons\":[\n                                        {\n                                            \"type\":\"postback\",\n                                            \"title\":\"Pedir a domicilio\",\n                                            \"payload\":\"ListCategories-0\"\n                                        },\n                                        {\n                                            \"type\":\"postback\",\n                                            \"title\":\"Pedir para recoger\",\n                                            \"payload\":\"ListCategories-0\"\n                                        },\n                                        {\n                                            \"type\":\"postback\",\n                                            \"title\":\"Servicio al cliente\",\n                                            \"payload\":\"ListCategories-0\"\n                                        }\n                                    ]\n                                }]\n                            }\n                        }\n                    }\n                };\n\n                sendTypingOff(recipientId);\n                callSendAPI(messageData);\n            },\n            function(error) {\n                console.log(\"Lookup failed\");\n            });\n    } else {\n        console.error(response.error);\n    }\n}\n\n/**\n * CONSUMER ADDRESS LOADED action\n */\nexport function consumerAddressesLoaded(consumerAddresses) {\n    return {\n        type: types.CONSUMER_ADDRESSES_LOADED,\n        data: consumerAddresses\n    }\n}"]}